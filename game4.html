<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game 4 - Pac-Man</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            color: white;
            font-family: 'Courier New', Courier, monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        h1 {
            color: #ffcc00;
            margin: 10px 0;
            text-shadow: 2px 2px 0 #000;
        }

        #game-container {
            position: relative;
        }

        canvas {
            border: 3px solid #333;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(255, 255, 0, 0.3);
        }

        .start-screen, .game-over-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 10;
            text-align: center;
        }

        .start-screen h2, .game-over-screen h2 {
            font-size: 3em;
            margin-bottom: 20px;
            color: #ffcc00;
            text-shadow: 3px 3px 0 #000;
        }

        .start-screen p, .game-over-screen p {
            font-size: 1.2em;
            margin-bottom: 10px;
            max-width: 80%;
        }

        .controls {
            background: rgba(255, 255, 0, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #ffcc00;
        }

        .controls li {
            margin: 10px 0;
            text-align: left;
        }

        .start-btn, .restart-btn {
            padding: 15px 40px;
            font-size: 1.5em;
            background: #ffcc00;
            color: #000;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 20px;
            font-weight: bold;
            transition: transform 0.2s;
        }

        .start-btn:hover, .restart-btn:hover {
            transform: scale(1.05);
            background: #ffdd44;
        }

        .game-over-screen {
            display: none;
        }

        .game-info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-size: 1.2em;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            z-index: 5;
        }

        .game-info div {
            margin: 5px 0;
        }

        .timer-display {
            position: absolute;
            top: 10px;
            right: 10px;
            color: white;
            font-size: 1.2em;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            z-index: 5;
        }

        .score-display {
            position: absolute;
            top: 50px;
            right: 10px;
            color: white;
            font-size: 1.2em;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            z-index: 5;
        }
    </style>
</head>
<body>
    <h1>Pac-Man</h1>
    <div id="game-container">
        <canvas id="board"></canvas>
        
        <div class="start-screen">
            <h2>PAC-MAN</h2>
            <p>Ăn tất cả các chấm tránh ma!</p>
            <p>High Score: <span id="start-high-score">0</span></p>
            <p>Thời gian: 180 giây</p>
            <div class="controls">
                <p>Điều khiển:</p>
                <ul>
                    <li>W / Mũi tên lên: Đi lên</li>
                    <li>S / Mũi tên xuống: Đi xuống</li>
                    <li>A / Mũi tên trái: Đi trái</li>
                    <li>D / Mũi tên phải: Đi phải</li>
                    <li>Mỗi chấm: 10 điểm</li>
                    <li>Chạm ma: Mất 1 mạng</li>
                </ul>
            </div>
            <button class="start-btn" onclick="startGame()">Bắt đầu</button>
        </div>
        
        <div class="game-over-screen">
            <h2 id="game-over-title">Game Over!</h2>
            <p id="game-over-message"></p>
            <p>Điểm: <span id="final-score">0</span></p>
            <p>High Score: <span id="end-high-score">0</span></p>
            <button class="restart-btn" onclick="restartGame()">Chơi lại</button>
        </div>
        
        <div class="game-info">
            <div>Mạng: <span id="lives">3</span></div>
            <div>Cấp độ: <span id="level">1</span></div>
        </div>
        
        <div class="timer-display">
            Thời gian: <span id="time-left">180</span>s
        </div>
        
        <div class="score-display">
            Điểm: <span id="current-score">0</span>
        </div>
    </div>

    <script>
        // Game variables
        let board;
        const rowCount = 21;
        const columnCount = 19;
        const tileSize = 32;
        const boardWidth = columnCount * tileSize;
        const boardHeight = rowCount * tileSize;
        let context;

        // Game state
        let gameStarted = false;
        let gameTime = 180;
        let timeLeft = gameTime;
        let gameTimer;
        let level = 1;
        let highScore = localStorage.getItem('pacmanHighScore') || 0;
        let gameOverFlag = false;
        
        // Images
        let blueGhostImage;
        let orangeGhostImage;
        let pinkGhostImage;
        let redGhostImage;
        let pacmanUpImage;
        let pacmanDownImage;
        let pacmanLeftImage;
        let pacmanRightImage;
        let wallImage;
        
        // Tile map
        const tileMap = [
            "XXXXXXXXXXXXXXXXXXX",
            "X        X        X",
            "X XX XXX X XXX XX X",
            "X                 X",
            "X XX X XXXXX X XX X",
            "X    X       X    X",
            "XXXX XXXX XXXX XXXX",
            "OOOX X       X XOOO",
            "XXXX X XXrXX X XXXX",
            "O       bpo       O",
            "XXXX X XXXXX X XXXX",
            "OOOX X       X XOOO",
            "XXXX X XXXXX X XXXX",
            "X        X        X",
            "X XX XXX X XXX XX X",
            "X  X     P     X  X",
            "XX X X XXXXX X X XX",
            "X    X   X   X    X",
            "X XXXXXX X XXXXXX X",
            "X                 X",
            "XXXXXXXXXXXXXXXXXXX" 
        ];
        
        const walls = new Set();
        const foods = new Set();
        const ghosts = new Set();
        let pacman;
        
        const directions = ['U', 'D', 'L', 'R']; //up down left right
        let score = 0;
        let lives = 3;

        // Initialize
        window.onload = function() {
            board = document.getElementById("board");
            board.height = boardHeight;
            board.width = boardWidth;
            context = board.getContext("2d");
            
            document.getElementById('start-high-score').textContent = highScore;
            loadImages();
            loadMap();
        }

        function startGame() {
            document.querySelector('.start-screen').style.display = 'none';
            gameStarted = true;
            gameOverFlag = false;
            resetGame();
            startTimer();
            
            // Khởi tạo hướng cho ma
            for (let ghost of ghosts.values()) {
                const newDirection = directions[Math.floor(Math.random()*4)];
                ghost.updateDirection(newDirection);
            }
            
            update();
            document.addEventListener("keyup", movePacman);
        }

        function resetGame() {
            score = 0;
            lives = 3;
            level = 1;
            timeLeft = gameTime;
            gameOverFlag = false;
            
            document.getElementById('current-score').textContent = score;
            document.getElementById('lives').textContent = lives;
            document.getElementById('level').textContent = level;
            document.getElementById('time-left').textContent = timeLeft;
            
            loadMap();
            resetPositions();
            
            // Khởi tạo hướng cho ma
            for (let ghost of ghosts.values()) {
                const newDirection = directions[Math.floor(Math.random()*4)];
                ghost.updateDirection(newDirection);
            }
        }

        function startTimer() {
            clearInterval(gameTimer);
            gameTimer = setInterval(() => {
                timeLeft--;
                document.getElementById('time-left').textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    endGame("Hết giờ!");
                }
            }, 1000);
        }

        function loadImages() {
            wallImage = new Image();
            wallImage.src = "assets/pacman/wall.png";

            blueGhostImage = new Image();
            blueGhostImage.src = "assets/pacman/blueGhost.png";
            orangeGhostImage = new Image();
            orangeGhostImage.src = "assets/pacman/orangeGhost.png";
            pinkGhostImage = new Image();
            pinkGhostImage.src = "assets/pacman/pinkGhost.png";
            redGhostImage = new Image();
            redGhostImage.src = "assets/pacman/redGhost.png";

            pacmanUpImage = new Image();
            pacmanUpImage.src = "assets/pacman/pacmanUp.png";
            pacmanDownImage = new Image();
            pacmanDownImage.src = "assets/pacman/pacmanDown.png";
            pacmanLeftImage = new Image();
            pacmanLeftImage.src = "assets/pacman/pacmanLeft.png";
            pacmanRightImage = new Image();
            pacmanRightImage.src = "assets/pacman/pacmanRight.png";
        }

        function loadMap() {
            walls.clear();
            foods.clear();
            ghosts.clear();

            for (let r = 0; r < rowCount; r++) {
                for (let c = 0; c < columnCount; c++) {
                    const row = tileMap[r];
                    const tileMapChar = row[c];

                    const x = c * tileSize;
                    const y = r * tileSize;

                    if (tileMapChar == 'X') { //block wall
                        const wall = new Block(wallImage, x, y, tileSize, tileSize);
                        walls.add(wall);  
                    }
                    else if (tileMapChar == 'b') { //blue ghost
                        const ghost = new Block(blueGhostImage, x, y, tileSize, tileSize);
                        ghosts.add(ghost);
                    }
                    else if (tileMapChar == 'o') { //orange ghost
                        const ghost = new Block(orangeGhostImage, x, y, tileSize, tileSize);
                        ghosts.add(ghost);
                    }
                    else if (tileMapChar == 'p') { //pink ghost
                        const ghost = new Block(pinkGhostImage, x, y, tileSize, tileSize);
                        ghosts.add(ghost);
                    }
                    else if (tileMapChar == 'r') { //red ghost
                        const ghost = new Block(redGhostImage, x, y, tileSize, tileSize);
                        ghosts.add(ghost);
                    }
                    else if (tileMapChar == 'P') { //pacman
                        pacman = new Block(pacmanRightImage, x, y, tileSize, tileSize);
                    }
                    else if (tileMapChar == ' ') { //empty is food
                        const food = new Block(null, x + 14, y + 14, 4, 4);
                        foods.add(food);
                    }
                }
            }
        }

        function update() {
            if (gameOverFlag || !gameStarted) {
                return;
            }
            move();
            draw();
            setTimeout(update, 50); //1000/50 = 20 FPS (giữ nguyên tốc độ ban đầu)
        }

        function draw() {
            context.clearRect(0, 0, board.width, board.height);
            
            // Draw walls
            for (let wall of walls.values()) {
                context.drawImage(wall.image, wall.x, wall.y, wall.width, wall.height);
            }
            
            // Draw food
            context.fillStyle = "white";
            for (let food of foods.values()) {
                context.fillRect(food.x, food.y, food.width, food.height);
            }
            
            // Draw ghosts
            for (let ghost of ghosts.values()) {
                context.drawImage(ghost.image, ghost.x, ghost.y, ghost.width, ghost.height);
            }
            
            // Draw Pac-Man
            context.drawImage(pacman.image, pacman.x, pacman.y, pacman.width, pacman.height);
            
            // Draw score on canvas (bổ sung thêm hiển thị trên UI)
            context.fillStyle = "white";
            context.font = "14px sans-serif";
            context.fillText(`Lives: ${lives} Score: ${score}`, tileSize / 2, tileSize / 2);
        }

        function move() {
            // Di chuyển Pac-Man
            pacman.x += pacman.velocityX;
            pacman.y += pacman.velocityY;

            // Kiểm tra va chạm với tường
            for (let wall of walls.values()) {
                if (collision(pacman, wall)) {
                    pacman.x -= pacman.velocityX;
                    pacman.y -= pacman.velocityY;
                    break;
                }
            }

            // Kiểm tra va chạm với ma
            for (let ghost of ghosts.values()) {
                if (collision(ghost, pacman)) {
                    lives -= 1;
                    document.getElementById('lives').textContent = lives;
                    
                    if (lives == 0) {
                        endGame("Hết mạng!");
                        return;
                    }
                    resetPositions();
                }

                // Logic đặc biệt: nếu ma ở hàng 9 và không đi lên/xuống, cho nó đi lên
                if (ghost.y == tileSize * 9 && ghost.direction != 'U' && ghost.direction != 'D') {
                    ghost.updateDirection('U');
                }

                // Di chuyển ma
                ghost.x += ghost.velocityX;
                ghost.y += ghost.velocityY;
                
                // Kiểm tra va chạm tường cho ma
                for (let wall of walls.values()) {
                    if (collision(ghost, wall) || ghost.x <= 0 || ghost.x + ghost.width >= boardWidth) {
                        ghost.x -= ghost.velocityX;
                        ghost.y -= ghost.velocityY;
                        const newDirection = directions[Math.floor(Math.random() * 4)];
                        ghost.updateDirection(newDirection);
                    }
                }
            }

            // Kiểm tra va chạm với thức ăn
            let foodEaten = null;
            for (let food of foods.values()) {
                if (collision(pacman, food)) {
                    foodEaten = food;
                    score += 10;
                    document.getElementById('current-score').textContent = score;
                    break;
                }
            }
            foods.delete(foodEaten);

            // Lên cấp
            if (foods.size == 0) {
                level++;
                document.getElementById('level').textContent = level;
                loadMap();
                resetPositions();
                timeLeft += 30; // Thêm thời gian
                
                // Khởi tạo hướng cho ma
                for (let ghost of ghosts.values()) {
                    const newDirection = directions[Math.floor(Math.random() * 4)];
                    ghost.updateDirection(newDirection);
                }
            }
        }

        function movePacman(e) {
            if (!gameStarted || gameOverFlag) return;

            if (e.code == "ArrowUp" || e.code == "KeyW") {
                pacman.updateDirection('U');
            }
            else if (e.code == "ArrowDown" || e.code == "KeyS") {
                pacman.updateDirection('D');
            }
            else if (e.code == "ArrowLeft" || e.code == "KeyA") {
                pacman.updateDirection('L');
            }
            else if (e.code == "ArrowRight" || e.code == "KeyD") {
                pacman.updateDirection('R');
            }

            // Cập nhật hình ảnh Pac-Man
            if (pacman.direction == 'U') {
                pacman.image = pacmanUpImage;
            }
            else if (pacman.direction == 'D') {
                pacman.image = pacmanDownImage;
            }
            else if (pacman.direction == 'L') {
                pacman.image = pacmanLeftImage;
            }
            else if (pacman.direction == 'R') {
                pacman.image = pacmanRightImage;
            }
        }

        function collision(a, b) {
            return a.x < b.x + b.width &&
                   a.x + a.width > b.x &&
                   a.y < b.y + b.height &&
                   a.y + a.height > b.y;
        }

        function resetPositions() {
            pacman.reset();
            pacman.velocityX = 0;
            pacman.velocityY = 0;
            
            for (let ghost of ghosts.values()) {
                ghost.reset();
                const newDirection = directions[Math.floor(Math.random() * 4)];
                ghost.updateDirection(newDirection);
            }
        }

        function endGame(message) {
            gameOverFlag = true;
            gameStarted = false;
            clearInterval(gameTimer);
            
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('pacmanHighScore', highScore);
            }
            
            document.getElementById('final-score').textContent = score;
            document.getElementById('end-high-score').textContent = highScore;
            document.getElementById('game-over-message').textContent = message;
            document.querySelector('.game-over-screen').style.display = 'flex';
        }

        function restartGame() {
            document.querySelector('.game-over-screen').style.display = 'none';
            startGame();
        }

        // Block class - giữ nguyên logic gốc
        class Block {
            constructor(image, x, y, width, height) {
                this.image = image;
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;

                this.startX = x;
                this.startY = y;

                this.direction = 'R';
                this.velocityX = 0;
                this.velocityY = 0;
            }

            updateDirection(direction) {
                const prevDirection = this.direction;
                this.direction = direction;
                this.updateVelocity();
                this.x += this.velocityX;
                this.y += this.velocityY;
                
                for (let wall of walls.values()) {
                    if (collision(this, wall)) {
                        this.x -= this.velocityX;
                        this.y -= this.velocityY;
                        this.direction = prevDirection;
                        this.updateVelocity();
                        return;
                    }
                }
            }

            updateVelocity() {
                if (this.direction == 'U') {
                    this.velocityX = 0;
                    this.velocityY = -tileSize / 4;
                }
                else if (this.direction == 'D') {
                    this.velocityX = 0;
                    this.velocityY = tileSize / 4;
                }
                else if (this.direction == 'L') {
                    this.velocityX = -tileSize / 4;
                    this.velocityY = 0;
                }
                else if (this.direction == 'R') {
                    this.velocityX = tileSize / 4;
                    this.velocityY = 0;
                }
            }

            reset() {
                this.x = this.startX;
                this.y = this.startY;
            }
        }
    </script>
</body>
</html>